<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Compta Pro">
    <meta name="theme-color" content="#667eea">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23667eea' width='100' height='100'/%3E%3Ctext x='50%25' y='50%25' font-size='50' text-anchor='middle' dy='.3em' fill='white'%3Eüí∞%3C/text%3E%3C/svg%3E">
    <link rel="manifest" id="manifest-placeholder">
    <title>Comptabilit√© Auto-Entrepreneur</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-app {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header-app h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .stat-card .label {
            color: #718096;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #2d3748;
        }

        .stat-card.gain .value {
            color: #48bb78;
        }

        .stat-card.expense .value {
            color: #f56565;
        }

        .stat-card.net .value {
            color: #667eea;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #4a5568;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .form-inline {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #4a5568;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-danger {
            background: #f56565;
            color: white;
            padding: 8px 12px;
            font-size: 14px;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-warning:hover {
            background: #dd6b20;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        table thead {
            background: #4c63b6;
            color: white;
        }

        table th,
        table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #e2e8f0;
        }

        table th {
            font-weight: 600;
            font-size: 14px;
        }

        table tbody tr:hover {
            background: #f7fafc;
        }

        .gain-row {
            background: #f0fff4;
        }

        .expense-row {
            background: #fff5f5;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 12px 25px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #718096;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filters select,
        .filters input {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #ebf8ff;
            color: #2c5282;
            border-left: 4px solid #3182ce;
        }

        .alert-warning {
            background: #fffaf0;
            color: #7c2d12;
            border-left: 4px solid #ed8936;
        }

        .alert-success {
            background: #f0fff4;
            color: #22543d;
            border-left: 4px solid #48bb78;
        }

        .regime-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .regime-option {
            padding: 20px;
            border: 3px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .regime-option:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .regime-option.selected {
            border-color: #667eea;
            background: #ebf4ff;
        }

        .regime-option .taux {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .form-inline {
                grid-template-columns: 1fr;
            }
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .summary-item {
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .summary-item .label {
            color: #718096;
            font-size: 13px;
            margin-bottom: 5px;
        }

        .summary-item .value {
            font-size: 1.3em;
            font-weight: bold;
            color: #2d3748;
        }

        .export-section {
            margin-top: 20px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-app">
            <h1>üí∞ Comptabilit√© Auto-Entrepreneur</h1>
            <p>Suivez vos revenus, d√©penses et cotisations en temps r√©el</p>
            <button id="install-btn" class="btn btn-success" style="display:none; margin-top:15px;">
                üì≤ Installer l'application sur cet appareil
            </button>
        </div>

        <!-- Dashboard -->
        <div class="dashboard">
            <div class="stat-card gain">
                <div class="icon">üíö</div>
                <div class="label">Chiffre d'Affaires</div>
                <div class="value" id="total-gains">0,00 ‚Ç¨</div>
            </div>
            <div class="stat-card expense">
                <div class="icon">üí∏</div>
                <div class="label">D√©penses</div>
                <div class="value" id="total-expenses">0,00 ‚Ç¨</div>
            </div>
            <div class="stat-card">
                <div class="icon">üìä</div>
                <div class="label">Cotisations √† Payer</div>
                <div class="value" id="total-cotisations">0,00 ‚Ç¨</div>
            </div>
            <div class="stat-card net">
                <div class="icon">üíé</div>
                <div class="label">B√©n√©fice Net</div>
                <div class="value" id="net-profit">0,00 ‚Ç¨</div>
            </div>
        </div>

        <!-- Configuration R√©gime -->
        <div class="card">
            <h2>‚öôÔ∏è Configuration du R√©gime</h2>
            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Information :</strong> S√©lectionnez votre activit√© pour calculer automatiquement vos cotisations sociales.
            </div>
            <div class="regime-selector">
                <div class="regime-option" data-taux="12.3" onclick="selectRegime(this)">
                    <div>üõí <strong>Vente de marchandises</strong></div>
                    <div class="taux">12,3%</div>
                    <small>Achat-revente, restauration</small>
                </div>
                <div class="regime-option selected" data-taux="21.2" onclick="selectRegime(this)">
                    <div>üîß <strong>Prestations de services BIC</strong></div>
                    <div class="taux">21,2%</div>
                    <small>Artisanat, m√©canique</small>
                </div>
                <div class="regime-option" data-taux="23.1" onclick="selectRegime(this)">
                    <div>üíº <strong>Prestations de services BNC</strong></div>
                    <div class="taux">23,1%</div>
                    <small>Professions lib√©rales</small>
                </div>
            </div>
            <div class="form-group">
                <label>Ou saisissez un taux personnalis√© (%)</label>
                <input type="number" id="custom-taux" step="0.1" placeholder="21.2" oninput="updateTaux()">
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <strong>Taux actuel : <span id="current-taux">21,2</span>%</strong>
            </div>
        </div>

        <!-- Tabs -->
        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('saisie')">‚ûï Saisie</button>
                <button class="tab" onclick="switchTab('historique')">üìú Historique</button>
                <button class="tab" onclick="switchTab('analyse')">üìä Analyse</button>
                <button class="tab" onclick="switchTab('declarations')">üìù D√©clarations</button>
            </div>

            <!-- Tab Saisie -->
            <div id="tab-saisie" class="tab-content active">
                <h2>Ajouter une Transaction</h2>
                
                <div class="form-inline">
                    <div class="form-group">
                        <label>Type *</label>
                        <select id="transaction-type">
                            <option value="gain">üíö Gain / Recette</option>
                            <option value="expense">üí∏ D√©pense</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="transaction-date" required>
                    </div>
                    <div class="form-group">
                        <label>Montant (‚Ç¨) *</label>
                        <input type="number" id="transaction-amount" step="0.01" placeholder="150.00" required>
                    </div>
                </div>

                <div class="form-inline">
                    <div class="form-group">
                        <label>Cat√©gorie *</label>
                        <select id="transaction-category">
                            <optgroup label="üíö Gains">
                                <option value="facture-client">Facture client</option>
                                <option value="vente">Vente</option>
                                <option value="prestation">Prestation de service</option>
                                <option value="autre-gain">Autre gain</option>
                            </optgroup>
                            <optgroup label="üí∏ D√©penses">
                                <option value="achat-materiel">Achat mat√©riel</option>
                                <option value="pieces">Pi√®ces d√©tach√©es</option>
                                <option value="carburant">Carburant</option>
                                <option value="assurance">Assurance</option>
                                <option value="loyer">Loyer / Local</option>
                                <option value="telephone">T√©l√©phone / Internet</option>
                                <option value="publicite">Publicit√©</option>
                                <option value="formation">Formation</option>
                                <option value="comptable">Expert-comptable</option>
                                <option value="autre-depense">Autre d√©pense</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Client / Fournisseur</label>
                        <input type="text" id="transaction-client" placeholder="Nom">
                    </div>
                    <div class="form-group">
                        <label>R√©f√©rence / N¬∞ facture</label>
                        <input type="text" id="transaction-ref" placeholder="F-2024-001">
                    </div>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea id="transaction-description" rows="3" placeholder="D√©tails de la transaction..."></textarea>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="transaction-paid" checked> 
                        Transaction pay√©e / encaiss√©e
                    </label>
                </div>

                <button class="btn btn-success" onclick="addTransaction()">üíæ Enregistrer la transaction</button>
                <button class="btn btn-primary" onclick="importFromInvoices()">üì• Importer depuis mes factures</button>
            </div>

            <!-- Tab Historique -->
            <div id="tab-historique" class="tab-content">
                <h2>Historique des Transactions</h2>
                
                <div class="filters">
                    <select id="filter-type" onchange="filterTransactions()">
                        <option value="all">Tous types</option>
                        <option value="gain">üíö Gains uniquement</option>
                        <option value="expense">üí∏ D√©penses uniquement</option>
                    </select>
                    <select id="filter-year" onchange="filterTransactions()">
                        <option value="all">Toutes ann√©es</option>
                    </select>
                    <select id="filter-month" onchange="filterTransactions()">
                        <option value="all">Tous mois</option>
                        <option value="0">Janvier</option>
                        <option value="1">F√©vrier</option>
                        <option value="2">Mars</option>
                        <option value="3">Avril</option>
                        <option value="4">Mai</option>
                        <option value="5">Juin</option>
                        <option value="6">Juillet</option>
                        <option value="7">Ao√ªt</option>
                        <option value="8">Septembre</option>
                        <option value="9">Octobre</option>
                        <option value="10">Novembre</option>
                        <option value="11">D√©cembre</option>
                    </select>
                    <input type="text" id="filter-search" placeholder="üîç Rechercher..." oninput="filterTransactions()">
                </div>

                <div class="table-container">
                    <table id="transactions-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Cat√©gorie</th>
                                <th>Description</th>
                                <th>Client/Fournisseur</th>
                                <th>Montant</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-tbody">
                            <tr>
                                <td colspan="8" style="text-align:center;color:#a0aec0;">Aucune transaction enregistr√©e</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab Analyse -->
            <div id="tab-analyse" class="tab-content">
                <h2>Analyse Financi√®re</h2>
                
                <div class="form-group">
                    <label>P√©riode d'analyse</label>
                    <select id="analyse-period" onchange="updateCharts()">
                        <option value="year">Ann√©e en cours</option>
                        <option value="month">Mois en cours</option>
                        <option value="quarter">Trimestre en cours</option>
                        <option value="all">Depuis le d√©but</option>
                    </select>
                </div>

                <div class="chart-container">
                    <canvas id="chart-evolution"></canvas>
                </div>

                <div class="chart-container">
                    <canvas id="chart-categories"></canvas>
                </div>

                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="label">CA Moyen / Mois</div>
                        <div class="value" id="avg-monthly-ca">0,00 ‚Ç¨</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">D√©penses Moyennes / Mois</div>
                        <div class="value" id="avg-monthly-expenses">0,00 ‚Ç¨</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Taux de marge</div>
                        <div class="value" id="margin-rate">0%</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Meilleur mois</div>
                        <div class="value" id="best-month">-</div>
                    </div>
                </div>
            </div>

            <!-- Tab D√©clarations -->
            <div id="tab-declarations" class="tab-content">
                <h2>R√©capitulatif pour D√©clarations</h2>

                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Rappel :</strong> Pensez √† d√©clarer votre CA chaque mois ou trimestre selon votre r√©gime. Les cotisations sont calcul√©es automatiquement selon votre taux.
                </div>

                <div class="form-group">
                    <label>S√©lectionner l'ann√©e</label>
                    <select id="declaration-year" onchange="generateDeclaration()">
                    </select>
                </div>

                <div id="declaration-content">
                    <!-- Le contenu sera g√©n√©r√© ici -->
                </div>

                <div class="export-section">
                    <h3>üì• Export des donn√©es</h3>
                    <button class="btn btn-primary" onclick="exportToCSV()">üìä Exporter en CSV</button>
                    <button class="btn btn-success" onclick="exportToJSON()">üíæ Sauvegarder une copie JSON</button>
                    <button class="btn btn-warning" onclick="printDeclaration()">üñ®Ô∏è Imprimer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let transactions = [];
        let currentTaux = 21.2;
        let chartEvolution = null;
        let chartCategories = null;
        let deferredPrompt;

        // G√©n√©rer le manifeste PWA dynamiquement pour le mode plein √©cran
        const manifest = {
            name: "Comptabilit√© Auto-Entrepreneur",
            short_name: "Compta Pro",
            start_url: window.location.href,
            display: "standalone",
            background_color: "#667eea",
            theme_color: "#667eea",
            orientation: "any",
            description: "Gestion comptable pour auto-entrepreneur",
            icons: [
                {
                    src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23667eea' width='100' height='100'/%3E%3Ctext x='50%25' y='50%25' font-size='50' text-anchor='middle' dy='.3em' fill='white'%3Eüí∞%3C/text%3E%3C/svg%3E",
                    sizes: "512x512",
                    type: "image/svg+xml",
                    purpose: "any maskable"
                }
            ]
        };

        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);

        // PWA Installation
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-btn').style.display = 'inline-block';
        });

        document.getElementById('install-btn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('install-btn').style.display = 'none';
                }
                deferredPrompt = null;
            }
        });

        // Service Worker pour fonctionnement hors ligne
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    self.addEventListener('install', (e) => {
                        self.skipWaiting();
                    });
                    self.addEventListener('activate', (e) => {
                        self.clients.claim();
                    });
                    self.addEventListener('fetch', (e) => {
                        e.respondWith(
                            caches.match(e.request).then(response => response || fetch(e.request))
                        );
                    });
                `;
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swUrl);
            });
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transaction-date').value = today;
            
            // Forcer le mode plein √©cran
            requestFullscreen();
            
            loadTransactions();
            updateDashboard();
            populateYearFilters();
            initCharts();
        });

        // Fonction pour activer le plein √©cran
        function requestFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen().catch(() => {});
            } else if (elem.webkitRequestFullscreen) { // Safari
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) { // IE11
                elem.msRequestFullscreen();
            }
        }

        // Ajouter un bouton de plein √©cran visible
        window.addEventListener('load', function() {
            // Cr√©er un bouton flottant pour le plein √©cran
            const fullscreenBtn = document.createElement('button');
            fullscreenBtn.innerHTML = '‚õ∂';
            fullscreenBtn.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                background: #667eea;
                color: white;
                border: none;
                font-size: 24px;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            fullscreenBtn.onclick = requestFullscreen;
            document.body.appendChild(fullscreenBtn);

            // Masquer le bouton si d√©j√† en plein √©cran
            document.addEventListener('fullscreenchange', function() {
                fullscreenBtn.style.display = document.fullscreenElement ? 'none' : 'flex';
            });
        });

        function selectRegime(element) {
            document.querySelectorAll('.regime-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            currentTaux = parseFloat(element.dataset.taux);
            document.getElementById('current-taux').textContent = currentTaux.toFixed(1);
            document.getElementById('custom-taux').value = '';
            updateDashboard();
            saveConfig();
        }

        function updateTaux() {
            const customTaux = parseFloat(document.getElementById('custom-taux').value);
            if (customTaux && customTaux > 0 && customTaux <= 100) {
                currentTaux = customTaux;
                document.getElementById('current-taux').textContent = currentTaux.toFixed(1);
                document.querySelectorAll('.regime-option').forEach(el => el.classList.remove('selected'));
                updateDashboard();
                saveConfig();
            }
        }

        function saveConfig() {
            localStorage.setItem('ae-config', JSON.stringify({
                taux: currentTaux
            }));
        }

        function loadConfig() {
            const config = localStorage.getItem('ae-config');
            if (config) {
                const parsed = JSON.parse(config);
                currentTaux = parsed.taux || 21.2;
                document.getElementById('current-taux').textContent = currentTaux.toFixed(1);
            }
        }

        function addTransaction() {
            const type = document.getElementById('transaction-type').value;
            const date = document.getElementById('transaction-date').value;
            const amount = parseFloat(document.getElementById('transaction-amount').value);
            const category = document.getElementById('transaction-category').value;
            const client = document.getElementById('transaction-client').value;
            const ref = document.getElementById('transaction-ref').value;
            const description = document.getElementById('transaction-description').value;
            const paid = document.getElementById('transaction-paid').checked;

            if (!date || !amount || amount <= 0) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }

            const transaction = {
                id: Date.now(),
                type,
                date,
                amount,
                category,
                client,
                ref,
                description,
                paid,
                timestamp: new Date().toISOString()
            };

            transactions.push(transaction);
            saveTransactions();
            updateDashboard();
            displayTransactions();
            updateCharts();

            // Reset form
            document.getElementById('transaction-amount').value = '';
            document.getElementById('transaction-client').value = '';
            document.getElementById('transaction-ref').value = '';
            document.getElementById('transaction-description').value = '';

            alert('‚úÖ Transaction enregistr√©e avec succ√®s !');
        }

        function deleteTransaction(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette transaction ?')) {
                transactions = transactions.filter(t => t.id !== id);
                saveTransactions();
                updateDashboard();
                displayTransactions();
                updateCharts();
            }
        }

        function saveTransactions() {
            localStorage.setItem('ae-transactions', JSON.stringify(transactions));
        }

        function loadTransactions() {
            const saved = localStorage.getItem('ae-transactions');
            if (saved) {
                transactions = JSON.parse(saved);
            }
            loadConfig();
            displayTransactions();
        }

        function updateDashboard() {
            const gains = transactions.filter(t => t.type === 'gain' && t.paid)
                .reduce((sum, t) => sum + t.amount, 0);
            
            const expenses = transactions.filter(t => t.type === 'expense' && t.paid)
                .reduce((sum, t) => sum + t.amount, 0);
            
            const cotisations = gains * (currentTaux / 100);
            const netProfit = gains - expenses - cotisations;

            document.getElementById('total-gains').textContent = formatEuro(gains);
            document.getElementById('total-expenses').textContent = formatEuro(expenses);
            document.getElementById('total-cotisations').textContent = formatEuro(cotisations);
            document.getElementById('net-profit').textContent = formatEuro(netProfit);
        }

        function displayTransactions() {
            filterTransactions();
        }

        function filterTransactions() {
            const typeFilter = document.getElementById('filter-type').value;
            const yearFilter = document.getElementById('filter-year').value;
            const monthFilter = document.getElementById('filter-month').value;
            const searchFilter = document.getElementById('filter-search').value.toLowerCase();

            let filtered = transactions;

            if (typeFilter !== 'all') {
                filtered = filtered.filter(t => t.type === typeFilter);
            }

            if (yearFilter !== 'all') {
                filtered = filtered.filter(t => new Date(t.date).getFullYear() === parseInt(yearFilter));
            }

            if (monthFilter !== 'all') {
                filtered = filtered.filter(t => new Date(t.date).getMonth() === parseInt(monthFilter));
            }

            if (searchFilter) {
                filtered = filtered.filter(t => 
                    t.description.toLowerCase().includes(searchFilter) ||
                    t.client.toLowerCase().includes(searchFilter) ||
                    t.ref.toLowerCase().includes(searchFilter) ||
                    t.category.toLowerCase().includes(searchFilter)
                );
            }

            const tbody = document.getElementById('transactions-tbody');
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#a0aec0;">Aucune transaction trouv√©e</td></tr>';
                return;
            }

            // Trier par date d√©croissante
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            tbody.innerHTML = filtered.map(t => `
                <tr class="${t.type}-row">
                    <td>${formatDate(t.date)}</td>
                    <td>${t.type === 'gain' ? 'üíö Gain' : 'üí∏ D√©pense'}</td>
                    <td>${getCategoryLabel(t.category)}</td>
                    <td>${t.description || '-'}</td>
                    <td>${t.client || '-'}</td>
                    <td style="font-weight:bold;color:${t.type === 'gain' ? '#48bb78' : '#f56565'}">${formatEuro(t.amount)}</td>
                    <td>${t.paid ? '‚úÖ Pay√©' : '‚è≥ En attente'}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteTransaction(${t.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function getCategoryLabel(category) {
            const labels = {
                'facture-client': 'Facture client',
                'vente': 'Vente',
                'prestation': 'Prestation',
                'autre-gain': 'Autre gain',
                'achat-materiel': 'Achat mat√©riel',
                'pieces': 'Pi√®ces',
                'carburant': 'Carburant',
                'assurance': 'Assurance',
                'loyer': 'Loyer',
                'telephone': 'T√©l√©phone',
                'publicite': 'Publicit√©',
                'formation': 'Formation',
                'comptable': 'Comptable',
                'autre-depense': 'Autre d√©pense'
            };
            return labels[category] || category;
        }

        function populateYearFilters() {
            const years = [...new Set(transactions.map(t => new Date(t.date).getFullYear()))];
            years.sort((a, b) => b - a);
            
            const currentYear = new Date().getFullYear();
            if (!years.includes(currentYear)) {
                years.unshift(currentYear);
            }

            const yearFilter = document.getElementById('filter-year');
            const declarationYear = document.getElementById('declaration-year');

            years.forEach(year => {
                yearFilter.innerHTML += `<option value="${year}">${year}</option>`;
                declarationYear.innerHTML += `<option value="${year}">${year}</option>`;
            });

            declarationYear.value = currentYear;
            generateDeclaration();
        }

        function initCharts() {
            const ctxEvolution = document.getElementById('chart-evolution').getContext('2d');
            const ctxCategories = document.getElementById('chart-categories').getContext('2d');

            chartEvolution = new Chart(ctxEvolution, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Gains',
                        data: [],
                        borderColor: '#48bb78',
                        backgroundColor: 'rgba(72, 187, 120, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'D√©penses',
                        data: [],
                        borderColor: '#f56565',
                        backgroundColor: 'rgba(245, 101, 101, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '√âvolution des Gains et D√©penses'
                        }
                    }
                }
            });

            chartCategories = new Chart(ctxCategories, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#667eea', '#48bb78', '#ed8936', '#f56565', 
                            '#9f7aea', '#38b2ac', '#ecc94b', '#fc8181'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'R√©partition des D√©penses par Cat√©gorie'
                        }
                    }
                }
            });

            updateCharts();
        }

        function updateCharts() {
            const period = document.getElementById('analyse-period').value;
            let filteredTransactions = [...transactions];

            const now = new Date();
            if (period === 'year') {
                filteredTransactions = filteredTransactions.filter(t => 
                    new Date(t.date).getFullYear() === now.getFullYear()
                );
            } else if (period === 'month') {
                filteredTransactions = filteredTransactions.filter(t => {
                    const d = new Date(t.date);
                    return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth();
                });
            } else if (period === 'quarter') {
                const quarter = Math.floor(now.getMonth() / 3);
                filteredTransactions = filteredTransactions.filter(t => {
                    const d = new Date(t.date);
                    return d.getFullYear() === now.getFullYear() && 
                           Math.floor(d.getMonth() / 3) === quarter;
                });
            }

            // Graphique d'√©volution
            const monthlyData = {};
            filteredTransactions.forEach(t => {
                const month = new Date(t.date).toLocaleDateString('fr-FR', { year: 'numeric', month: 'short' });
                if (!monthlyData[month]) {
                    monthlyData[month] = { gains: 0, expenses: 0 };
                }
                if (t.type === 'gain' && t.paid) {
                    monthlyData[month].gains += t.amount;
                } else if (t.type === 'expense' && t.paid) {
                    monthlyData[month].expenses += t.amount;
                }
            });

            const months = Object.keys(monthlyData).sort();
            chartEvolution.data.labels = months;
            chartEvolution.data.datasets[0].data = months.map(m => monthlyData[m].gains);
            chartEvolution.data.datasets[1].data = months.map(m => monthlyData[m].expenses);
            chartEvolution.update();

            // Graphique cat√©gories
            const categoryData = {};
            filteredTransactions.filter(t => t.type === 'expense' && t.paid).forEach(t => {
                const cat = getCategoryLabel(t.category);
                categoryData[cat] = (categoryData[cat] || 0) + t.amount;
            });

            chartCategories.data.labels = Object.keys(categoryData);
            chartCategories.data.datasets[0].data = Object.values(categoryData);
            chartCategories.update();

            // Statistiques
            updateAnalysisStats(filteredTransactions);
        }

        function updateAnalysisStats(filteredTransactions) {
            const gains = filteredTransactions.filter(t => t.type === 'gain' && t.paid);
            const expenses = filteredTransactions.filter(t => t.type === 'expense' && t.paid);

            const totalGains = gains.reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = expenses.reduce((sum, t) => sum + t.amount, 0);

            const months = [...new Set(gains.map(t => new Date(t.date).toLocaleDateString('fr-FR', { year: 'numeric', month: 'short' })))].length;
            const avgMonthlyCA = months > 0 ? totalGains / months : 0;
            const avgMonthlyExpenses = months > 0 ? totalExpenses / months : 0;
            
            const marginRate = totalGains > 0 ? ((totalGains - totalExpenses) / totalGains * 100) : 0;

            document.getElementById('avg-monthly-ca').textContent = formatEuro(avgMonthlyCA);
            document.getElementById('avg-monthly-expenses').textContent = formatEuro(avgMonthlyExpenses);
            document.getElementById('margin-rate').textContent = marginRate.toFixed(1) + '%';

            // Meilleur mois
            const monthlyGains = {};
            gains.forEach(t => {
                const month = new Date(t.date).toLocaleDateString('fr-FR', { year: 'numeric', month: 'long' });
                monthlyGains[month] = (monthlyGains[month] || 0) + t.amount;
            });
            const bestMonth = Object.keys(monthlyGains).reduce((a, b) => 
                monthlyGains[a] > monthlyGains[b] ? a : b, '-'
            );
            document.getElementById('best-month').textContent = bestMonth;
        }

        function generateDeclaration() {
            const year = parseInt(document.getElementById('declaration-year').value);
            const yearTransactions = transactions.filter(t => 
                new Date(t.date).getFullYear() === year && t.paid
            );

            const quarters = [
                { name: 'T1 (Jan-F√©v-Mar)', months: [0, 1, 2] },
                { name: 'T2 (Avr-Mai-Juin)', months: [3, 4, 5] },
                { name: 'T3 (Juil-Ao√ªt-Sep)', months: [6, 7, 8] },
                { name: 'T4 (Oct-Nov-D√©c)', months: [9, 10, 11] }
            ];

            let html = `
                <div class="alert alert-success">
                    <strong>Ann√©e ${year}</strong>
                </div>
            `;

            quarters.forEach(quarter => {
                const qTransactions = yearTransactions.filter(t => 
                    quarter.months.includes(new Date(t.date).getMonth())
                );
                const qGains = qTransactions.filter(t => t.type === 'gain').reduce((s, t) => s + t.amount, 0);
                const qExpenses = qTransactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
                const qCotisations = qGains * (currentTaux / 100);

                html += `
                    <div class="summary-item" style="margin-bottom: 20px;">
                        <h3>${quarter.name}</h3>
                        <div class="summary-grid">
                            <div>
                                <div class="label">Chiffre d'affaires</div>
                                <div class="value">${formatEuro(qGains)}</div>
                            </div>
                            <div>
                                <div class="label">Cotisations (${currentTaux}%)</div>
                                <div class="value">${formatEuro(qCotisations)}</div>
                            </div>
                            <div>
                                <div class="label">D√©penses</div>
                                <div class="value">${formatEuro(qExpenses)}</div>
                            </div>
                            <div>
                                <div class="label">Net apr√®s cotisations</div>
                                <div class="value">${formatEuro(qGains - qCotisations - qExpenses)}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            const yearGains = yearTransactions.filter(t => t.type === 'gain').reduce((s, t) => s + t.amount, 0);
            const yearExpenses = yearTransactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            const yearCotisations = yearGains * (currentTaux / 100);

            html += `
                <div class="alert alert-info">
                    <h3>üìä R√©capitulatif Annuel ${year}</h3>
                    <div class="summary-grid" style="margin-top: 15px;">
                        <div>
                            <div class="label">CA Total</div>
                            <div class="value">${formatEuro(yearGains)}</div>
                        </div>
                        <div>
                            <div class="label">Cotisations Totales</div>
                            <div class="value">${formatEuro(yearCotisations)}</div>
                        </div>
                        <div>
                            <div class="label">D√©penses Totales</div>
                            <div class="value">${formatEuro(yearExpenses)}</div>
                        </div>
                        <div>
                            <div class="label">B√©n√©fice Net</div>
                            <div class="value">${formatEuro(yearGains - yearCotisations - yearExpenses)}</div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('declaration-content').innerHTML = html;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            if (tabName === 'analyse') {
                updateCharts();
            } else if (tabName === 'declarations') {
                generateDeclaration();
            }
        }

        function importFromInvoices() {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            
            if (invoices.length === 0) {
                alert('Aucune facture trouv√©e. Cr√©ez des factures d\'abord avec le g√©n√©rateur de factures.');
                return;
            }

            let imported = 0;
            invoices.forEach(inv => {
                // V√©rifier si d√©j√† import√©e
                const exists = transactions.find(t => 
                    t.ref === inv.numero && 
                    t.type === 'gain'
                );

                if (!exists) {
                    const amount = parseFloat(inv.totalTTC.replace(/[^\d,]/g, '').replace(',', '.'));
                    
                    transactions.push({
                        id: Date.now() + Math.random(),
                        type: 'gain',
                        date: inv.date,
                        amount: amount,
                        category: 'facture-client',
                        client: inv.client,
                        ref: inv.numero,
                        description: `Facture #${inv.numero}`,
                        paid: true,
                        timestamp: new Date().toISOString()
                    });
                    imported++;
                }
            });

            if (imported > 0) {
                saveTransactions();
                updateDashboard();
                displayTransactions();
                updateCharts();
                alert(`‚úÖ ${imported} facture(s) import√©e(s) avec succ√®s !`);
            } else {
                alert('Toutes les factures ont d√©j√† √©t√© import√©es.');
            }
        }

        function exportToCSV() {
            let csv = 'Date;Type;Cat√©gorie;Description;Client/Fournisseur;Montant;R√©f√©rence;Statut\n';
            
            transactions.forEach(t => {
                csv += `${t.date};${t.type === 'gain' ? 'Gain' : 'D√©pense'};${getCategoryLabel(t.category)};${t.description};${t.client};${t.amount};${t.ref};${t.paid ? 'Pay√©' : 'En attente'}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `comptabilite_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function exportToJSON() {
            const data = {
                transactions: transactions,
                config: { taux: currentTaux },
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `comptabilite_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function printDeclaration() {
            window.print();
        }

        function formatEuro(amount) {
            return amount.toFixed(2).replace('.', ',') + ' ‚Ç¨';
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('fr-FR');
        }
    </script>
</body>
</html>
